<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Korean Vocabulary Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            max-width: 90%;
            width: 768px;
        }
        .card {
            background-color: #2d3748; /* Darker background for card */
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            padding: 2rem;
        }
        .btn {
            background-color: #4a5568;
            color: #e2e8f0;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            border: none;
            cursor: pointer;
        }
        .btn:hover {
            background-color: #718096;
            transform: translateY(-2px);
        }
        .option-btn {
            background-color: #4a5568;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.75rem;
            transition: all 0.2s ease-in-out;
            border: 2px solid #4a5568;
        }
        .option-btn:hover:not([disabled]) {
            background-color: #718096;
            transform: scale(1.02);
        }
        .option-btn.selected {
            border-color: #38a169;
        }
        .correct {
            background-color: #38a169 !important; /* Green */
        }
        .incorrect {
            background-color: #e53e3e !important; /* Red */
        }
        .feedback {
            font-weight: bold;
            margin-top: 1rem;
            text-align: center;
        }
        @media (max-width: 768px) {
            .container {
                max-width: 100%;
            }
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom styles for image display */
        .question-image {
            max-width: 100%;
            height: auto;
            border-radius: 0.75rem;
            margin: 0 auto 1.5rem;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container flex flex-col items-center">
        <div id="loader-overlay" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden">
            <div class="flex flex-col items-center p-8 bg-gray-800 rounded-lg shadow-xl">
                <div class="loader"></div>
                <p class="text-white mt-4">Generating your quiz...</p>
            </div>
        </div>

        <div id="main-content" class="w-full">
            <div id="vocab-section" class="card space-y-6">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-3xl font-bold text-teal-300">John Mark Korean Vocab Questions Builder</h1>
                    <div id="user-id-display" class="bg-gray-700 text-sm px-3 py-1 rounded-full text-gray-400">User ID: Loading...</div>
                </div>

                <p class="text-gray-400">Enter Korean vocabulary words, one per line (e.g., "안녕하세요" or "사과").</p>
                <textarea id="vocab-input" class="w-full h-40 p-4 rounded-lg bg-gray-700 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-teal-500 resize-y" placeholder="e.g.
가다
배우다
책
..."></textarea>
                <div class="flex justify-end space-x-4">
                    <button id="save-vocab-btn" class="btn">Save Vocab</button>
                    <button id="start-quiz-btn" class="btn hidden">Start Quiz</button>
                </div>
                
                <div id="vocab-list-container" class="mt-8">
                    <h2 class="text-xl font-bold mb-2">Your Vocabulary List:</h2>
                    <ul id="vocab-list" class="list-disc list-inside space-y-2 text-gray-300">
                        <li id="no-vocab-msg" class="text-gray-500 italic">No vocabulary added yet.</li>
                    </ul>
                </div>
            </div>

            <div id="quiz-section" class="card hidden space-y-6">
                <h1 id="quiz-title" class="text-3xl font-bold text-teal-300 text-center">Quiz Time!</h1>
                <div id="quiz-card" class="space-y-4">
                    <div class="text-center text-gray-400">
                        Question <span id="current-question-num">1</span> of <span id="total-questions-num"></span>
                    </div>
                    <div class="bg-gray-700 p-6 rounded-lg">
                        <img id="question-image" class="question-image hidden" alt="Question-related image">
                        <p id="question-text" class="text-xl text-white text-center"></p>
                    </div>
                    <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Options will be generated here -->
                    </div>
                    <div id="quiz-feedback" class="text-center font-bold text-lg mt-4 hidden"></div>
                    <div id="explanation-text" class="text-center text-gray-300 mt-2 p-2 bg-gray-700 rounded-lg hidden"></div>
                    <div class="flex justify-end mt-4">
                        <button id="next-question-btn" class="btn hidden">Next Question</button>
                    </div>
                </div>
                
                <div id="quiz-summary" class="hidden text-center space-y-4">
                    <h2 class="text-2xl font-bold text-teal-300">Quiz Complete!</h2>
                    <p id="summary-text" class="text-xl"></p>
                    <button id="return-to-vocab-btn" class="btn">Return to Vocab</button>
                    <button id="restart-quiz-btn" class="btn">Restart</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // Firestore and Gemini API configuration
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, auth, db;
        let userId = null;
        let vocabList = [];
        let quizQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let isAnswered = false;

        const geminiApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent`;
        const geminiApiKey = ""; // This will be provided by the runtime environment

        // UI Elements
        const vocabSection = document.getElementById('vocab-section');
        const quizSection = document.getElementById('quiz-section');
        const vocabInput = document.getElementById('vocab-input');
        const vocabListUl = document.getElementById('vocab-list');
        const noVocabMsg = document.getElementById('no-vocab-msg');
        const saveVocabBtn = document.getElementById('save-vocab-btn');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const loaderOverlay = document.getElementById('loader-overlay');
        const userIdDisplay = document.getElementById('user-id-display');
        const questionTextElem = document.getElementById('question-text');
        const questionImageElem = document.getElementById('question-image');
        const optionsContainer = document.getElementById('options-container');
        const currentQuestionNum = document.getElementById('current-question-num');
        const totalQuestionsNum = document.getElementById('total-questions-num');
        const nextQuestionBtn = document.getElementById('next-question-btn');
        const quizFeedback = document.getElementById('quiz-feedback');
        const explanationText = document.getElementById('explanation-text');
        const quizSummary = document.getElementById('quiz-summary');
        const summaryText = document.getElementById('summary-text');
        const returnToVocabBtn = document.getElementById('return-to-vocab-btn');
        const restartQuizBtn = document.getElementById('restart-quiz-btn');

        // Initial setup and auth listener
        async function setupFirebase() {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);
                    console.log("Firebase initialized.");
                    
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            userIdDisplay.textContent = `User ID: ${userId}`;
                            console.log("User authenticated:", userId);
                            listenToVocab();
                        } else {
                            userId = null;
                            console.log("No user signed in. Signing in anonymously...");
                            await signInAnonymously(auth);
                        }
                    });

                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (error) {
                            console.error("Error signing in with custom token:", error);
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                } else {
                    console.error("Firebase config is missing. Cannot initialize Firestore.");
                    userIdDisplay.textContent = `User ID: N/A`;
                    // Fallback for non-persistent functionality
                    vocabList = JSON.parse(localStorage.getItem('vocabList') || '[]');
                    displayVocabList();
                }
            } catch (error) {
                console.error("Error during Firebase setup:", error);
            }
        }

        // Firestore data listeners and handlers
        function getVocabDocRef() {
            if (!userId || !db) {
                console.error("Firestore not ready. User ID or DB is null.");
                return null;
            }
            // Updated path to use a public collection that is writable by authenticated users
            return doc(db, 'artifacts', appId, 'public', 'data', 'vocabulary', userId);
        }

        function listenToVocab() {
            const vocabDocRef = getVocabDocRef();
            if (vocabDocRef) {
                onSnapshot(vocabDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        vocabList = docSnap.data().words || [];
                        vocabInput.value = vocabList.join('\n');
                        console.log("Vocabulary list updated from Firestore.");
                    } else {
                        vocabList = [];
                        vocabInput.value = '';
                        console.log("No vocabulary found for this user.");
                    }
                    displayVocabList();
                }, (error) => {
                    console.error("Error listening to Firestore document:", error);
                });
            }
        }

        // UI Functions
        function displayVocabList() {
            vocabListUl.innerHTML = '';
            if (vocabList.length > 0) {
                noVocabMsg.classList.add('hidden');
                vocabList.forEach(word => {
                    const li = document.createElement('li');
                    li.textContent = word;
                    vocabListUl.appendChild(li);
                });
                startQuizBtn.classList.remove('hidden');
            } else {
                noVocabMsg.classList.remove('hidden');
                startQuizBtn.classList.add('hidden');
            }
        }

        function showQuizSection() {
            vocabSection.classList.add('hidden');
            quizSection.classList.remove('hidden');
        }

        function showVocabSection() {
            vocabSection.classList.remove('hidden');
            quizSection.classList.add('hidden');
        }

        // Event listeners
        saveVocabBtn.addEventListener('click', async () => {
            const words = vocabInput.value.split('\n').map(word => word.trim()).filter(word => word.length > 0);
            if (words.length === 0) {
                // Replaced alert with console.log for a smoother user experience
                console.log("Please enter some vocabulary words.");
                return;
            }
            
            vocabList = words;
            displayVocabList();

            if (db && userId) {
                const vocabDocRef = getVocabDocRef();
                if (vocabDocRef) {
                    try {
                        await setDoc(vocabDocRef, { words });
                        console.log("Vocabulary saved to Firestore.");
                    } catch (error) {
                        console.error("Error saving vocabulary to Firestore:", error);
                    }
                }
            } else {
                localStorage.setItem('vocabList', JSON.stringify(vocabList));
                console.log("Vocabulary saved to local storage (Firestore not available).");
            }
        });

        startQuizBtn.addEventListener('click', async () => {
            if (vocabList.length === 0) {
                // Replaced alert with a message in the UI or console.log
                console.log("Please enter some vocabulary words first.");
                return;
            }
            
            showLoader();
            try {
                const prompt = `Generate a multiple-choice quiz about Korean vocabulary in the style of an EPS/DMW exam. For each of the following words: ${vocabList.join(', ')}. Create a question that is a mix of English and Korean, with 4 options in Korean. The response should be a JSON array of objects, where each object has a 'question' (the question text), 'options' (an array of 4 Korean words/phrases), 'correctAnswer' (the correct Korean word/phrase), 'explanation' (a brief English explanation for the correct answer), and an optional 'imageUrl' field. The 'imageUrl' should be a placeholder image URL from https://placehold.co/400x300/1e293b/fff?text= (followed by a relevant English word for the image). The correct answer must be one of the provided words. The 'imageUrl' field should be present for about half of the questions.`;
                
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "question": { "type": "STRING" },
                                    "options": {
                                        "type": "ARRAY",
                                        "items": { "type": "STRING" },
                                        "minItems": 4,
                                        "maxItems": 4
                                    },
                                    "correctAnswer": { "type": "STRING" },
                                    "explanation": { "type": "STRING" },
                                    "imageUrl": { "type": "STRING" }
                                },
                                "propertyOrdering": ["question", "options", "correctAnswer", "explanation", "imageUrl"]
                            }
                        }
                    }
                };
                
                const response = await fetch(geminiApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0) {
                    const jsonContent = result.candidates[0].content.parts[0].text;
                    quizQuestions = JSON.parse(jsonContent);
                    startQuiz();
                } else {
                    console.error("API response did not contain a valid quiz.");
                    // Replaced alert with a console log
                    console.log("Failed to generate quiz. Please try again.");
                }

            } catch (error) {
                console.error("Error generating quiz:", error);
                // Replaced alert with a console log
                console.log("An error occurred while generating the quiz. Please check your network connection and try again.");
            } finally {
                hideLoader();
            }
        });

        nextQuestionBtn.addEventListener('click', () => {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizQuestions.length) {
                displayQuestion();
            } else {
                showQuizSummary();
            }
        });

        restartQuizBtn.addEventListener('click', () => {
            startQuiz();
        });

        returnToVocabBtn.addEventListener('click', () => {
            showVocabSection();
            quizSummary.classList.add('hidden');
        });

        // Quiz Logic
        function startQuiz() {
            if (quizQuestions.length === 0) {
                console.log("No questions were generated. Please try again.");
                return;
            }
            showQuizSection();
            quizSummary.classList.add('hidden');
            currentQuestionIndex = 0;
            score = 0;
            totalQuestionsNum.textContent = quizQuestions.length;
            displayQuestion();
        }

        function displayQuestion() {
            const q = quizQuestions[currentQuestionIndex];
            currentQuestionNum.textContent = currentQuestionIndex + 1;
            questionTextElem.textContent = q.question;
            optionsContainer.innerHTML = '';
            quizFeedback.classList.add('hidden');
            explanationText.classList.add('hidden');
            nextQuestionBtn.classList.add('hidden');
            isAnswered = false;

            // Handle image display
            if (q.imageUrl) {
                questionImageElem.src = q.imageUrl;
                questionImageElem.classList.remove('hidden');
            } else {
                questionImageElem.classList.add('hidden');
                questionImageElem.src = ''; // Clear image src
            }

            q.options.forEach(option => {
                const btn = document.createElement('button');
                btn.textContent = option;
                btn.classList.add('option-btn', 'w-full', 'text-left');
                btn.addEventListener('click', () => handleAnswer(btn, option, q.correctAnswer, q.explanation));
                optionsContainer.appendChild(btn);
            });
        }

        function handleAnswer(selectedBtn, selectedOption, correctAnswer, explanation) {
            if (isAnswered) return;
            isAnswered = true;

            const allOptions = optionsContainer.querySelectorAll('.option-btn');
            allOptions.forEach(btn => btn.disabled = true);

            if (selectedOption === correctAnswer) {
                score++;
                selectedBtn.classList.add('correct');
                quizFeedback.textContent = "Correct!";
                quizFeedback.classList.remove('text-red-500');
                quizFeedback.classList.add('text-green-500');
            } else {
                selectedBtn.classList.add('incorrect');
                quizFeedback.textContent = `Incorrect. The correct answer was "${correctAnswer}".`;
                quizFeedback.classList.remove('text-green-500');
                quizFeedback.classList.add('text-red-500');
                // Highlight the correct answer
                allOptions.forEach(btn => {
                    if (btn.textContent === correctAnswer) {
                        btn.classList.add('correct');
                    }
                });
            }
            
            quizFeedback.classList.remove('hidden');
            explanationText.textContent = explanation;
            explanationText.classList.remove('hidden');

            if (currentQuestionIndex < quizQuestions.length - 1) {
                nextQuestionBtn.classList.remove('hidden');
            } else {
                nextQuestionBtn.classList.add('hidden');
                showQuizSummary();
            }
        }

        function showQuizSummary() {
            quizSection.classList.add('hidden');
            quizSummary.classList.remove('hidden');
            summaryText.textContent = `You scored ${score} out of ${quizQuestions.length}!`;
        }

        function showLoader() {
            loaderOverlay.classList.remove('hidden');
        }

        function hideLoader() {
            loaderOverlay.classList.add('hidden');
        }

        // Initialize the app on window load
        window.onload = setupFirebase;
    </script>
</body>
</html>
